{% extends "base.html" %}

{% block content %}
  <div class="d-flex align-items-center mb-4">
    <h2><i class="mdi mdi-clipboard-list-outline"></i> Review Matches</h2>
    <form method="post" action="{{ url_for('main.cancel_review') }}" style="margin-left:auto;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn primary">
        <i class="mdi mdi-close-circle-outline"></i>
        Cancel &amp; Start Over
      </button>
    </form>
  </div>

  <div style="margin-bottom: 2rem;">
    <h2 style="margin-bottom: 1rem; color: var(--text);">
      <i class="mdi mdi-clipboard-check-outline"></i>
      Product & Ingredient Match Review
    </h2>

    <!-- Dgraph Information -->
    <div style="background: rgba(139, 179, 57, 0.1); padding: 1rem; border-radius: 4px; border: 1px solid var(--accent);">
      <h4 style="color: var(--accent); margin: 0 0 0.5rem 0; font-size: 1rem;">
        <i class="mdi mdi-information-outline"></i> Review Process
      </h4>
      <p style="margin: 0; color: var(--text); font-size: 0.9rem; line-height: 1.4;">
        <strong>What you're reviewing:</strong> Products and ingredients from your uploaded file that need to be matched to existing records or marked as new.
        <br><br>
        <strong>Businesses:</strong> Are automatically created during file processing and don't require review.
        <br><br>
        <strong>Your choices:</strong> For each product/ingredient, approve a match to link to existing data, or mark as "new" to create a new record. 
        After completing all reviews, you can push the approved decisions to your database.
      </p>
    </div>
  </div>

  <!-- Review Statistics -->
  <div class="review-stats">
    <div class="stat-card">
      <div class="stat-number">{{ pending_reviews|length }}</div>
      <div class="stat-label">Pending Reviews</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ pending_reviews|selectattr('new_item.type', 'equalto', 'product')|list|length }}</div>
      <div class="stat-label">Products</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ pending_reviews|selectattr('new_item.type', 'equalto', 'ingredient')|list|length }}</div>
      <div class="stat-label">Ingredients</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ pending_reviews|selectattr('score', 'ge', 80)|list|length }}</div>
      <div class="stat-label">High Confidence</div>
    </div>
  </div>

  <!-- Enhanced Batch Actions -->
  <div class="batch-actions-section">
    <h4><i class="mdi mdi-lightning-bolt"></i> Quick Actions</h4>
    
    <div class="batch-actions-grid">
      <div class="batch-action-card">
        <h5>High Confidence Items</h5>
        <p>Auto-approve items with 90%+ match confidence</p>
        <form method="post" action="{{ url_for('main.batch_approve_high_confidence') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn accent">
            <i class="mdi mdi-auto-fix-high"></i>
            Auto-Approve High Confidence
          </button>
        </form>
      </div>
      
      <div class="batch-action-card">
        <h5>All Items as New</h5>
        <p>Approve all pending items as new products/ingredients</p>
        <form method="post" action="{{ url_for('main.batch_save_decisions') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn accent">
            <i class="mdi mdi-content-save-all"></i>
            Save All as New Items
          </button>
        </form>
      </div>
      
      <div class="batch-action-card">
        <h5>Ignore All</h5>
        <p>Skip all pending review items</p>
        <form method="post" action="{{ url_for('main.batch_ignore_all') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn" style="color:#e85a5a; border-color:#e85a5a;">
            <i class="mdi mdi-trash-can-outline"></i>
            Ignore All
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Smart Filtering -->
  <div class="filter-section">
    <div class="filter-controls">
      <input type="text" id="search-input" placeholder="Search items..." class="search-input">
      <label for="type-filter" class="filter-label">Type:</label>
      <select id="type-filter" class="filter-select" title="Filter by item type">
        <option value="">All Types</option>
        <option value="product">Products Only</option>
        <option value="ingredient">Ingredients Only</option>
      </select>
      <label for="confidence-filter" class="filter-label">Confidence:</label>
      <select id="confidence-filter" class="filter-select" title="Filter by confidence level">
        <option value="">All Confidence Levels</option>
        <option value="high">High (80%+)</option>
        <option value="medium">Medium (60-79%)</option>
        <option value="low">Low (<60%)</option>
      </select>
      <button onclick="clearFilters()" class="btn btn-secondary">Clear Filters</button>
    </div>
  </div>

  <!-- Review Items -->
  <div id="review-items-container">
    {% for review in pending_reviews %}
      <div class="card mb-4 review-item" 
           data-type="{{ review.new_item.type }}"
           data-confidence="{{ 'high' if review.score >= 80 else 'medium' if review.score >= 60 else 'low' }}"
           data-name="{{ review.new_item.name.lower() }}">
        <div class="review-header">
          <div class="item-info">
            <h3 class="card-title">
              "{{ review.new_item.name }}"
            </h3>
            <span class="type-label {{ review.new_item.type|lower }}">
              {{ review.new_item.type|capitalize }}
            </span>
            <span class="confidence-badge confidence-{{ 'high' if review.score >= 80 else 'medium' if review.score >= 60 else 'low' }}">
              {{ "%.1f"|format(review.score) if review.score else 'N/A' }}%
            </span>
          </div>
          
          <!-- Quick Actions -->
          <div class="quick-actions">
            <button onclick="quickApprove('{{ review.new_item_id }}', 'new')" class="btn-quick btn-quick-new" title="Mark as New">
              <i class="mdi mdi-plus-circle"></i> New
            </button>
            {% if review.suggested_ext_id %}
            <button onclick="quickApprove('{{ review.new_item_id }}', '{{ review.suggested_ext_id }}')" class="btn-quick btn-quick-match" title="Use Best Match">
              <i class="mdi mdi-check-circle"></i> Match
            </button>
            {% endif %}
          </div>
        </div>
        
        <!-- Item Context -->
        <div class="item-context">
          <p style="margin: 0; color: var(--text); font-size: 0.9rem;">
            <strong>Source:</strong> {{ review.new_item.submission.name if review.new_item.submission else 'Unknown' }} | 
            <strong>Type:</strong> {{ review.new_item.type|capitalize }} | 
            <strong>Confidence:</strong> {{ "%.1f"|format(review.score) if review.score else 'N/A' }}%
          </p>
        </div>

        <p class="card-text">
          Select the best match from your canonical data, mark as new, or ignore this item:
        </p>
        
        <form action="{{ url_for('main.handle_review', item_id=review.new_item_id) }}"
              method="post" style="margin-bottom:.5rem;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <ul class="radio-list">
            <!-- Top suggestion -->
            {% if review.suggested_ext_id %}
            <li>
              <label>
                <input type="radio"
                       name="choice"
                       value="{{ review.suggested_ext_id }}">
                <strong>{{ review.suggested_name }}</strong>
                <span class="muted">({{ "%.2f"|format(review.score) }}%)</span>
                <span style="color: var(--accent); font-size: 0.8rem;">← Best Match</span>
              </label>
            </li>
            {% endif %}
            
            <!-- Alternatives -->
            {% for alt in review.alternatives %}
            <li style="padding-left:1.5rem;">
              <label>
                <input type="radio"
                       name="choice"
                       value="{{ alt.ext_id }}">
                {{ alt.name }}
                <span class="muted">({{ "%.2f"|format(alt.score) }}%)</span>
              </label>
            </li>
            {% endfor %}
            
            <!-- New / no match -->
            <li>
              <label>
                <input type="radio"
                       name="choice"
                       value="__new__"
                       checked>
                <em>→ New / No match in canonical data</em>
                <span style="color: var(--primary); font-size: 0.8rem;">← Will create new {{ review.new_item.type }} in Dgraph</span>
              </label>
            </li>
          </ul>
          
          <button type="submit" class="btn accent">
            <i class="mdi mdi-content-save"></i>
            Save Decision
          </button>
        </form>
        
        <form action="{{ url_for('main.ignore_review_item', item_id=review.new_item_id) }}" method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn" style="color:#e85a5a; border-color:#e85a5a; background:none; margin-top:.3rem;">
            <i class="mdi mdi-trash-can-outline"></i> Ignore / Remove this item
          </button>
        </form>
      </div>
    {% endfor %}
  </div>

  <!-- No results message -->
  <div id="no-results" class="no-results" style="display: none;">
    <div class="text-center">
      <i class="mdi mdi-magnify" style="font-size: 3rem; color: var(--muted);"></i>
      <h3>No items match your filters</h3>
      <p>Try adjusting your search criteria or clearing the filters.</p>
    </div>
  </div>
{% endblock %}

<script>
// Search and filtering functionality
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('search-input');
  const typeFilter = document.getElementById('type-filter');
  const confidenceFilter = document.getElementById('confidence-filter');
  const reviewItems = document.querySelectorAll('.review-item');
  const noResults = document.getElementById('no-results');

  function filterItems() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedType = typeFilter.value;
    const selectedConfidence = confidenceFilter.value;
    
    let visibleCount = 0;
    
    reviewItems.forEach(item => {
      const itemName = item.dataset.name;
      const itemType = item.dataset.type;
      const itemConfidence = item.dataset.confidence;
      
      const matchesSearch = !searchTerm || itemName.includes(searchTerm);
      const matchesType = !selectedType || itemType === selectedType;
      const matchesConfidence = !selectedConfidence || itemConfidence === selectedConfidence;
      
      if (matchesSearch && matchesType && matchesConfidence) {
        item.style.display = 'block';
        visibleCount++;
      } else {
        item.style.display = 'none';
      }
    });
    
    // Show/hide no results message
    if (visibleCount === 0) {
      noResults.style.display = 'block';
    } else {
      noResults.style.display = 'none';
    }
  }

  // Add event listeners
  searchInput.addEventListener('input', filterItems);
  typeFilter.addEventListener('change', filterItems);
  confidenceFilter.addEventListener('change', filterItems);
});

function clearFilters() {
  document.getElementById('search-input').value = '';
  document.getElementById('type-filter').value = '';
  document.getElementById('confidence-filter').value = '';
  
  // Show all items
  document.querySelectorAll('.review-item').forEach(item => {
    item.style.display = 'block';
  });
  document.getElementById('no-results').style.display = 'none';
}

function quickApprove(itemId, choice) {
  // Create a form and submit it programmatically
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = `/reviews/handle_review/${itemId}`;
  
  const csrfToken = document.querySelector('input[name="csrf_token"]').value;
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrf_token';
  csrfInput.value = csrfToken;
  
  const choiceInput = document.createElement('input');
  choiceInput.type = 'hidden';
  choiceInput.name = 'choice';
  choiceInput.value = choice;
  
  form.appendChild(csrfInput);
  form.appendChild(choiceInput);
  document.body.appendChild(form);
  form.submit();
}
</script>

<style>
.review-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 1rem;
  text-align: center;
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 0.5rem;
}

.stat-label {
  color: var(--muted);
  font-size: 0.9rem;
}

.batch-actions-section {
  margin-bottom: 2rem;
}

.batch-actions-section h4 {
  margin-bottom: 1rem;
  color: var(--text);
}

.batch-actions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1rem;
}

.batch-action-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 1rem;
}

.batch-action-card h5 {
  margin: 0 0 0.5rem 0;
  color: var(--text);
}

.batch-action-card p {
  margin: 0 0 1rem 0;
  color: var(--muted);
  font-size: 0.9rem;
}

.filter-section {
  margin-bottom: 2rem;
  padding: 1rem;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 6px;
}

.filter-controls {
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}

.filter-label {
  font-weight: 500;
  color: var(--text);
  font-size: 0.9rem;
}

.search-input, .filter-select {
  padding: 0.5rem;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--bg);
  color: var(--text);
  min-width: 150px;
}

.btn-secondary {
  background: var(--card-bg);
  border: 1px solid var(--border);
  color: var(--text);
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
}

.item-info {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.confidence-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 500;
}

.confidence-high {
  background: rgba(76, 175, 80, 0.2);
  color: #4caf50;
}

.confidence-medium {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
}

.confidence-low {
  background: rgba(244, 67, 54, 0.2);
  color: #f44336;
}

.quick-actions {
  display: flex;
  gap: 0.5rem;
}

.btn-quick {
  padding: 0.25rem 0.5rem;
  border: 1px solid;
  border-radius: 4px;
  background: none;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.2s ease;
}

.btn-quick-new {
  border-color: var(--primary);
  color: var(--primary);
}

.btn-quick-new:hover {
  background: var(--primary);
  color: var(--bg);
}

.btn-quick-match {
  border-color: var(--accent);
  color: var(--accent);
}

.btn-quick-match:hover {
  background: var(--accent);
  color: var(--bg);
}

.item-context {
  background: rgba(212, 175, 55, 0.1);
  padding: 0.75rem;
  border-radius: 4px;
  margin-bottom: 1rem;
  border-left: 3px solid var(--primary);
}

.no-results {
  text-align: center;
  padding: 3rem;
  color: var(--muted);
}

.no-results h3 {
  margin: 1rem 0 0.5rem 0;
  color: var(--text);
}

@media (max-width: 768px) {
  .filter-controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-input, .filter-select {
    min-width: auto;
  }
  
  .review-header {
    flex-direction: column;
    gap: 1rem;
  }
  
  .quick-actions {
    align-self: stretch;
    justify-content: center;
  }
}
</style>
