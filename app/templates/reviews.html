{% extends "base.html" %}

{% block content %}
  <!-- Toast notifications for review feedback -->
  <script>
    // Show toast notifications based on URL parameters
    document.addEventListener('DOMContentLoaded', function() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');
        const message = urlParams.get('message');
        
        if (status && message) {
          const decodedMessage = decodeURIComponent(message);
          
          // Wait a bit for toast functions to be available
          setTimeout(() => {
            try {
              switch(status) {
                case 'success':
                  if (typeof showSuccess === 'function') {
                    showSuccess(decodedMessage);
                  } else {
                    console.error('showSuccess function not available');
                  }
                  break;
                case 'error':
                  if (typeof showError === 'function') {
                    showError(decodedMessage);
                  } else {
                    console.error('showError function not available');
                  }
                  break;
                case 'warning':
                  if (typeof showWarning === 'function') {
                    showWarning(decodedMessage);
                  } else {
                    console.error('showWarning function not available');
                  }
                  break;
                case 'info':
                  if (typeof showInfo === 'function') {
                    showInfo(decodedMessage);
                  } else {
                    console.error('showInfo function not available');
                  }
                  break;
              }
            } catch (error) {
              console.error('Error showing toast:', error);
            }
          }, 100);
          
          // Clean up URL parameters
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      } catch (error) {
        console.error('Error processing URL parameters:', error);
      }
    });
  </script>
  <div class="d-flex align-items-center mb-4">
    <h2><i class="mdi mdi-clipboard-list-outline"></i> Review Matches</h2>
    <form method="post" action="{{ url_for('main.cancel_review') }}" style="margin-left:auto;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn primary">
        <i class="mdi mdi-close-circle-outline"></i>
        Cancel &amp; Start Over
      </button>
    </form>
  </div>

  <div style="margin-bottom: 2rem;">
    <h2 style="margin-bottom: 1rem; color: var(--text);">
      <i class="mdi mdi-clipboard-check-outline"></i>
      Product & Ingredient Match Review
    </h2>

    <!-- Dgraph Information -->
    <div style="background: rgba(139, 179, 57, 0.1); padding: 1rem; border-radius: 4px; border: 1px solid var(--accent);">
      <h4 style="color: var(--accent); margin: 0 0 0.5rem 0; font-size: 1rem;">
        <i class="mdi mdi-information-outline"></i> Review Process
      </h4>
      <p style="margin: 0; color: var(--text); font-size: 0.9rem; line-height: 1.4;">
        <strong>What you're reviewing:</strong> Products and ingredients from your uploaded file that need to be matched to existing records or marked as new.
        <br><br>
        <strong>Businesses:</strong> Are automatically created during file processing and don't require review.
        <br><br>
        <strong>Your choices:</strong> For each product/ingredient, approve a match to link to existing data, or mark as "new" to create a new record. 
        After completing all reviews, you can push the approved decisions to your database.
      </p>
    </div>
  </div>

  <!-- Review Statistics -->
  <div class="review-stats" style="display: flex !important; flex-direction: row !important; gap: 1rem !important; margin-bottom: 1.5rem !important; align-items: center !important; justify-content: flex-start !important; flex-wrap: wrap !important; background: rgba(139, 179, 57, 0.05) !important; padding: 0.75rem !important; border-radius: 6px !important; border: 1px solid rgba(139, 179, 57, 0.1) !important;">
    <div class="stat-card" style="background: var(--card-bg) !important; border: 1px solid var(--border) !important; border-radius: 6px !important; padding: 0.75rem 1rem !important; text-align: center !important; min-width: 90px !important; margin: 0 !important; flex-shrink: 0 !important; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;">
      <div class="stat-number" style="color: var(--primary) !important; font-size: 1.75rem !important; font-weight: 700 !important; margin-bottom: 0.25rem !important; line-height: 1 !important;">{{ pending_reviews|length }}</div>
      <div class="stat-label" style="color: var(--text) !important; font-size: 0.75rem !important; font-weight: 500 !important; text-transform: uppercase !important; letter-spacing: 0.3px !important;">Pending Reviews</div>
    </div>
    <div class="stat-card" style="background: var(--card-bg) !important; border: 1px solid var(--border) !important; border-radius: 6px !important; padding: 0.75rem 1rem !important; text-align: center !important; min-width: 90px !important; margin: 0 !important; flex-shrink: 0 !important; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;">
      <div class="stat-number" style="color: var(--accent) !important; font-size: 1.75rem !important; font-weight: 700 !important; margin-bottom: 0.25rem !important; line-height: 1 !important;">{{ pending_reviews|selectattr('new_item.type', 'equalto', 'product')|list|length }}</div>
      <div class="stat-label" style="color: var(--text) !important; font-size: 0.75rem !important; font-weight: 500 !important; text-transform: uppercase !important; letter-spacing: 0.3px !important;">Products</div>
    </div>
    <div class="stat-card" style="background: var(--card-bg) !important; border: 1px solid var(--border) !important; border-radius: 6px !important; padding: 0.75rem 1rem !important; text-align: center !important; min-width: 90px !important; margin: 0 !important; flex-shrink: 0 !important; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;">
      <div class="stat-number" style="color: #d4a574 !important; font-size: 1.75rem !important; font-weight: 700 !important; margin-bottom: 0.25rem !important; line-height: 1 !important;">{{ pending_reviews|selectattr('new_item.type', 'equalto', 'ingredient')|list|length }}</div>
      <div class="stat-label" style="color: var(--text) !important; font-size: 0.75rem !important; font-weight: 500 !important; text-transform: uppercase !important; letter-spacing: 0.3px !important;">Ingredients</div>
    </div>
    <div class="stat-card" style="background: var(--card-bg) !important; border: 1px solid var(--border) !important; border-radius: 6px !important; padding: 0.75rem 1rem !important; text-align: center !important; min-width: 90px !important; margin: 0 !important; flex-shrink: 0 !important; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;">
      <div class="stat-number" style="color: #8b9dc3 !important; font-size: 1.75rem !important; font-weight: 700 !important; margin-bottom: 0.25rem !important; line-height: 1 !important;">{{ pending_reviews|selectattr('score', 'ge', 90)|list|length }}</div>
      <div class="stat-label" style="color: var(--text) !important; font-size: 0.75rem !important; font-weight: 500 !important; text-transform: uppercase !important; letter-spacing: 0.3px !important;">High Confidence</div>
    </div>
  </div>

  <!-- Enhanced Item Summary -->
  <div style="background: rgba(212, 175, 55, 0.1); padding: 1rem; border-radius: 6px; border-left: 3px solid var(--primary); margin-bottom: 1.5rem;">
    <h4 style="color: var(--primary); margin: 0 0 0.5rem 0; font-size: 1rem;">
      <i class="mdi mdi-format-list-bulleted"></i> Complete Item Summary
    </h4>
    <p style="margin: 0; color: var(--text); font-size: 0.9rem; line-height: 1.4;">
      <strong>Items requiring review:</strong> {{ pending_reviews|length }} total items need your decision
      <br><strong>Breakdown:</strong> {{ pending_reviews|selectattr('new_item.type', 'equalto', 'product')|list|length }} products, {{ pending_reviews|selectattr('new_item.type', 'equalto', 'ingredient')|list|length }} ingredients
      <br><strong>Confidence levels:</strong> {{ pending_reviews|selectattr('score', 'ge', 90)|list|length }} high confidence (90%+), {{ pending_reviews|selectattr('score', 'ge', 60)|selectattr('score', 'lt', 90)|list|length }} medium (60-89%), {{ pending_reviews|selectattr('score', 'lt', 60)|list|length }} low (<60%)
                   <br><strong>Source files:</strong> {{ pending_reviews|map(attribute='new_item.member.submission.name')|unique|list|length }} file(s) being processed
      <br><strong>Businesses involved:</strong> {{ pending_reviews|map(attribute='new_item.member.name')|unique|list|length }} business(es) with items to review
    </p>
  </div>

  <!-- Enhanced Batch Actions -->
  <div class="batch-actions-section">
    <h4><i class="mdi mdi-lightning-bolt"></i> Quick Actions</h4>
    
    <div class="batch-actions-grid">
      <div class="batch-action-card">
        <h5>High Confidence Items</h5>
        <p>Auto-approve items with 90%+ match confidence (with semantic validation)</p>
        <form method="post" action="{{ url_for('main.batch_approve_high_confidence') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn accent">
            <i class="mdi mdi-auto-fix-high"></i>
            Auto-Approve High Confidence
          </button>
        </form>
      </div>
      
      <div class="batch-action-card">
        <h5>All Items as New</h5>
        <p>Approve all pending items as new products/ingredients</p>
        <form method="post" action="{{ url_for('main.batch_save_decisions') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn accent">
            <i class="mdi mdi-content-save-all"></i>
            Save All as New Items
          </button>
        </form>
      </div>
      
      <div class="batch-action-card">
        <h5>Ignore All</h5>
        <p>Skip all pending review items</p>
        <form method="post" action="{{ url_for('main.batch_ignore_all') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn" style="color:#e85a5a; border-color:#e85a5a;">
            <i class="mdi mdi-trash-can-outline"></i>
            Ignore All
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Smart Filtering -->
  <div class="filter-section">
    <div class="filter-controls" style="display: flex !important; flex-direction: row !important; gap: 1.5rem; align-items: center; flex-wrap: wrap; width: 100%;">
      <div class="filter-group" style="display: flex !important; align-items: center; gap: 0.5rem; flex-shrink: 0;">
        <i class="mdi mdi-magnify" style="color: var(--primary);"></i>
        <input type="text" id="search-input" placeholder="Search items..." class="search-input">
      </div>
      
      <div class="filter-group" style="display: flex !important; align-items: center; gap: 0.5rem; flex-shrink: 0;">
        <label for="type-filter" class="filter-label">Type:</label>
        <select id="type-filter" class="filter-select" title="Filter by item type">
          <option value="">All Types</option>
          <option value="product">Products Only</option>
          <option value="ingredient">Ingredients Only</option>
        </select>
      </div>
      
               <div class="filter-group" style="display: flex !important; align-items: center; gap: 0.5rem; flex-shrink: 0;">
           <label for="file-filter" class="filter-label">File:</label>
           <select id="file-filter" class="filter-select" title="Filter by source file">
             <option value="">All Files</option>
             {% for file_name in pending_reviews|map(attribute='new_item.member.submission.name')|unique|sort %}
               <option value="{{ file_name }}">{{ file_name }}</option>
             {% endfor %}
           </select>
         </div>
      
      <div class="filter-group" style="display: flex !important; align-items: center; gap: 0.5rem; flex-shrink: 0;">
        <label for="business-filter" class="filter-label">Business:</label>
        <select id="business-filter" class="filter-select" title="Filter by business name">
          <option value="">All Businesses</option>
          {% for business_name in pending_reviews|map(attribute='new_item.member.name')|unique|sort %}
            <option value="{{ business_name }}">{{ business_name }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filter-group" style="display: flex !important; align-items: center; gap: 0.5rem; flex-shrink: 0;">
        <label for="confidence-filter" class="filter-label">Confidence:</label>
        <select id="confidence-filter" class="filter-select" title="Filter by confidence level">
          <option value="">All Confidence Levels</option>
          <option value="high">High (90%+)</option>
          <option value="medium">Medium (60-89%)</option>
          <option value="low">Low (<60%)</option>
        </select>
      </div>
      
      <button onclick="clearFilters()" class="btn btn-secondary">
        <i class="mdi mdi-filter-remove"></i>
        Clear Filters
      </button>
    </div>
  </div>

  <!-- Review Items -->
  <div id="review-items-container">
    {% for review in pending_reviews %}
               <div class="card mb-4 review-item"
              data-type="{{ review.new_item.type }}"
              data-confidence="{{ 'high' if review.score >= 90 else 'medium' if review.score >= 60 else 'low' }}"
              data-name="{{ review.new_item.name.lower() }}"
              data-file="{{ review.new_item.member.submission.name if review.new_item.member and review.new_item.member.submission else 'Unknown' }}"
              data-business="{{ review.new_item.member.name if review.new_item.member else 'Unknown' }}"
              data-item-id="{{ review.new_item_id }}">
        <div class="review-header">
          <div class="item-info">
            <h3 class="card-title">
              "{{ review.new_item.name }}"
            </h3>
            <span class="type-label {{ review.new_item.type|lower }}">
              {{ review.new_item.type|capitalize }}
            </span>
            <span class="confidence-badge confidence-{{ 'high' if review.score >= 90 else 'medium' if review.score >= 60 else 'low' }}">
              {{ "%.1f"|format(review.score) if review.score else 'N/A' }}%
            </span>
          </div>
          
          <!-- Quick Actions -->
          <div class="quick-actions">
            <button onclick="quickApprove('{{ review.new_item_id }}', 'new')" class="btn-quick btn-quick-new" title="Mark as New">
              <i class="mdi mdi-plus-circle"></i> New
            </button>
            {% if review.suggested_ext_id %}
            <button onclick="quickApprove('{{ review.new_item_id }}', '{{ review.suggested_ext_id }}')" class="btn-quick btn-quick-match" title="Use Best Match">
              <i class="mdi mdi-check-circle"></i> Match
            </button>
            {% endif %}
          </div>
        </div>
        
        <!-- Item Context -->
        <div class="item-context">
          <p style="margin: 0; color: var(--text); font-size: 0.9rem;">
            <strong>Source:</strong> {{ review.new_item.member.submission.name if review.new_item.member and review.new_item.member.submission else 'Unknown' }} | 
            <strong>Business:</strong> {{ review.new_item.member.name if review.new_item.member else 'Unknown' }} | 
            <strong>Type:</strong> {{ review.new_item.type|capitalize }} | 
            <strong>Confidence:</strong> {{ "%.1f"|format(review.score) if review.score else 'N/A' }}%
          </p>
        </div>

        <p class="card-text">
          Select one or more matches from your canonical data, mark as new, or ignore this item:
        </p>
        
        <!-- Canonical matches form with Save Decision button -->
        <form action="{{ url_for('main.handle_review', item_id=review.new_item_id) }}"
               method="post" style="margin-bottom:.5rem;" id="review-form-{{ review.new_item_id }}"
               onsubmit="return handleFormSubmit(event, this);">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          
          <!-- Canonical Matches Section -->
          <div class="matches-section">
            <h5 style="color: var(--text); margin-bottom: 0.5rem;">
              <i class="mdi mdi-link-variant"></i> Canonical Matches (Select one or more):
            </h5>
            <ul class="checkbox-list">
              <!-- Top suggestion -->
              {% if review.suggested_ext_id %}
              <li>
                <label class="match-option">
                  <input type="checkbox"
                         name="canonical_choices"
                         value="{{ review.suggested_ext_id }}"
                         class="canonical-checkbox"
                         data-form-id="{{ review.new_item_id }}">
                  <strong>{{ review.suggested_name }}</strong>
                  <span class="muted">({{ "%.2f"|format(review.score) }}%)</span>
                  <span style="color: var(--accent); font-size: 0.8rem;">← Best Match</span>
                </label>
              </li>
              {% endif %}
              
              <!-- Alternatives -->
              {% for alt in review.alternatives %}
              <li style="padding-left:1.5rem;">
                <label class="match-option">
                  <input type="checkbox"
                         name="canonical_choices"
                         value="{{ alt.ext_id }}"
                         class="canonical-checkbox"
                         data-form-id="{{ review.new_item_id }}">
                  {{ alt.name }}
                  <span class="muted">({{ "%.2f"|format(alt.score) }}%)</span>
                </label>
              </li>
              {% endfor %}
            </ul>
          </div>
          
          <div class="form-validation" style="margin-top: 1rem; padding: 0.5rem; border-radius: 4px; display: none;" id="validation-{{ review.new_item_id }}">
            <p style="margin: 0; color: #e85a5a; font-size: 0.9rem;">
              <i class="mdi mdi-alert-circle"></i> 
              <span id="validation-text-{{ review.new_item_id }}">Please select at least one canonical match before submitting, or use "Create New" button.</span>
            </p>
          </div>
          
          <button type="submit" class="btn accent" id="submit-btn-{{ review.new_item_id }}">
            <i class="mdi mdi-content-save"></i>
            Save Decision
          </button>
        </form>
        
        <!-- New Item Section -->
        <div class="new-item-section" style="margin-top: 1rem;">
          <h5 style="color: var(--text); margin-bottom: 0.5rem;">
            <i class="mdi mdi-plus-circle"></i> Or Create New:
          </h5>
          <p style="margin: 0; color: var(--muted); font-size: 0.9rem;">
            If no canonical matches are suitable, create a new {{ review.new_item.type }} in Dgraph:
          </p>
        </div>
        
        <!-- Separate form for creating new item -->
        <form action="{{ url_for('main.handle_review', item_id=review.new_item_id) }}"
                method="post" style="margin-bottom:.5rem;" class="create-new-form"
                onsubmit="return handleFormSubmit(event, this);">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="choice" value="__new__">
          <button type="submit" class="btn primary" style="margin-top: 1rem; margin-bottom: 1.5rem;">
            <i class="mdi mdi-plus-circle"></i>
            Create New {{ review.new_item.type|capitalize }}
          </button>
        </form>
        
        <form action="{{ url_for('main.ignore_review_item', item_id=review.new_item_id) }}" method="post" class="ignore-form"
             onsubmit="return handleFormSubmit(event, this);">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn" style="color:#e85a5a; border-color:#e85a5a; background:none; margin-top:.3rem;">
            <i class="mdi mdi-trash-can-outline"></i> Ignore / Remove this item
          </button>
        </form>
      </div>
    {% endfor %}
  </div>

  <!-- No results message -->
  <div id="no-results" class="no-results" style="display: none;">
    <div class="text-center">
      <i class="mdi mdi-magnify" style="font-size: 3rem; color: var(--muted);"></i>
      <h3>No items match your filters</h3>
      <p>Try adjusting your search criteria or clearing the filters.</p>
    </div>
  </div>
{% endblock %}

<script>
// Clean, non-duplicated JavaScript for reviews page

// Toast notification system
function showReviewToast(message, type = 'info') {
    // Remove existing toasts to prevent stacking
    const existingToasts = document.querySelectorAll('.toast-notification');
    existingToasts.forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="mdi mdi-${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'information'}"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="mdi mdi-close"></i>
        </button>
    `;
    
    // Append to body
    document.body.appendChild(toast);
    
    // Position toast at top-right with slide animation
    toast.style.position = 'fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '10000';
    toast.style.transform = 'translateX(100%)';
    toast.style.transition = 'transform 0.3s ease-out';
    
    // Trigger slide-in animation
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 10);
    
    // Auto-remove with slide-out animation
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 300);
    }, 4000);
}

// Form submission handler
function handleFormSubmit(event, form) {
    console.log('Form submission intercepted:', form.action);
    event.preventDefault();
    event.stopPropagation();
    
    // Store current scroll position
    const scrollPos = window.scrollY;
    
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Processing...';
    submitBtn.disabled = true;
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response:', data);
        if (data.success) {
            // Show success message
            showReviewToast(data.message, 'success');
            
            // Remove the review item from the page
            const itemId = form.id ? form.id.replace('review-form-', '') : 'unknown';
            const reviewItem = document.querySelector(`[data-item-id="${itemId}"]`);
            if (reviewItem) {
                reviewItem.style.opacity = '0';
                reviewItem.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    reviewItem.remove();
                    updateStats();
                    // Restore scroll position
                    window.scrollTo(0, scrollPos);
                }, 300);
            } else {
                // Restore scroll position even if no item found
                window.scrollTo(0, scrollPos);
            }
        } else {
            showReviewToast(data.message || 'Error occurred', 'error');
            // Restore scroll position on error
            window.scrollTo(0, scrollPos);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showReviewToast('Error occurred. Please try again.', 'error');
        // Restore scroll position on error
        window.scrollTo(0, scrollPos);
    })
    .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
    
    return false;
}

// Update statistics after removing items
function updateStats() {
    const remainingItems = document.querySelectorAll('.review-item').length;
    const pendingReviewsElement = document.querySelector('.stat-card:nth-child(1) .stat-number');
    if (pendingReviewsElement) {
        pendingReviewsElement.textContent = remainingItems;
    }
    
    // Update other stats if needed
    const productsElement = document.querySelector('.stat-card:nth-child(2) .stat-number');
    const ingredientsElement = document.querySelector('.stat-card:nth-child(3) .stat-number');
    
    if (productsElement && ingredientsElement) {
        const products = document.querySelectorAll('.review-item[data-type="product"]').length;
        const ingredients = document.querySelectorAll('.review-item[data-type="ingredient"]').length;
        productsElement.textContent = products;
        ingredientsElement.textContent = ingredients;
    }
}

// Quick approve function
function quickApprove(itemId, choice) {
    const form = document.getElementById(`review-form-${itemId}`);
    if (!form) return;
    
    if (choice === 'new') {
        // Create a new form for the "Create New" action
        const newForm = document.createElement('form');
        newForm.method = 'POST';
        newForm.action = form.action;
        
        // Add CSRF token
        const csrfToken = form.querySelector('input[name="csrf_token"]');
        if (csrfToken) {
            const newCsrfInput = document.createElement('input');
            newCsrfInput.type = 'hidden';
            newCsrfInput.name = 'csrf_token';
            newCsrfInput.value = csrfToken.value;
            newForm.appendChild(newCsrfInput);
        }
        
        // Add choice parameter
        const choiceInput = document.createElement('input');
        choiceInput.type = 'hidden';
        choiceInput.name = 'choice';
        choiceInput.value = '__new__';
        newForm.appendChild(choiceInput);
        
        // Submit via AJAX
        handleFormSubmit({ preventDefault: () => {}, stopPropagation: () => {} }, newForm);
    } else {
        // Clear all selections first
        form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        // Select the specific canonical match
        const checkbox = form.querySelector(`input[value="${choice}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
        
        // Submit via AJAX
        handleFormSubmit({ preventDefault: () => {}, stopPropagation: () => {} }, form);
    }
}

// Form validation
function validateForm(formId) {
    const canonicalChoices = document.querySelectorAll(`#review-form-${formId} input[name="canonical_choices"]:checked`);
    const validationDiv = document.getElementById(`validation-${formId}`);
    const submitBtn = document.getElementById(`submit-btn-${formId}`);
    const validationText = document.getElementById(`validation-text-${formId}`);
    
    // Simple validation - must have at least one canonical choice selected
    const isValid = canonicalChoices.length > 0;
    
    if (!isValid) {
        validationDiv.style.display = 'block';
        validationText.textContent = 'Please select at least one canonical match before submitting, or use "Create New" button.';
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
    } else {
        validationDiv.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
    }
    
    return isValid;
}

// Initialize form validation on page load
document.addEventListener('DOMContentLoaded', function() {
    // Handle canonical checkbox changes for validation
    document.querySelectorAll('.canonical-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function(e) {
            const formId = this.getAttribute('data-form-id');
            validateForm(formId);
        });
    });
    
    // Initialize validation for each form
    document.querySelectorAll('form[id^="review-form-"]').forEach(function(form) {
        const formId = form.id.replace('review-form-', '');
        validateForm(formId);
    });
});
</script>

<style>
/* Hide flash messages on reviews page to prevent conflicts with toasts */
.flash-messages {
  display: none !important;
}

/* Toast Notification Styles */
.toast-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  z-index: 10000;
  min-width: 300px;
  border-left: 4px solid var(--primary);
  transform: translateX(100%);
  transition: transform 0.3s ease-out;
  pointer-events: auto;
}

.toast-success {
  border-left-color: #4CAF50;
}

.toast-error {
  border-left-color: #f44336;
}

.toast-info {
  border-left-color: var(--accent);
}

.toast-content {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: var(--text);
}

.toast-content i {
  font-size: 1.2rem;
}

.toast-success .toast-content i {
  color: #4CAF50;
}

.toast-error .toast-content i {
  color: #f44336;
}

.toast-info .toast-content i {
  color: var(--accent);
}

.toast-close {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.toast-close:hover {
  background: rgba(0, 0, 0, 0.1);
  color: var(--text);
}

/* Enhanced Review Statistics Styling */
.review-stats {
  display: flex !important;
  flex-direction: row !important;
  gap: 1rem !important;
  margin-bottom: 1.5rem !important;
  align-items: center !important;
  justify-content: flex-start !important;
  flex-wrap: wrap !important;
  background: rgba(139, 179, 57, 0.05) !important;
  padding: 0.75rem !important;
  border-radius: 6px !important;
  border: 1px solid rgba(139, 179, 57, 0.1) !important;
}

.stat-card {
  background: var(--card-bg) !important;
  border: 1px solid var(--border) !important;
  border-radius: 6px !important;
  padding: 0.75rem 1rem !important;
  text-align: center !important;
  min-width: 90px !important;
  transition: all 0.2s ease !important;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
  margin: 0 !important;
  flex-shrink: 0 !important;
}

.stat-card:hover {
  transform: translateY(-1px) !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
  border-color: var(--accent) !important;
}

.stat-number {
  font-size: 1.75rem !important;
  font-weight: 700 !important;
  margin-bottom: 0.25rem !important;
  line-height: 1 !important;
}

/* Individual stat number colors */
.stat-card:nth-child(1) .stat-number {
  color: var(--primary) !important; /* Theme primary color for Pending Reviews */
}

.stat-card:nth-child(2) .stat-number {
  color: var(--accent) !important; /* Theme accent color for Products */
}

.stat-card:nth-child(3) .stat-number {
  color: #d4a574 !important; /* Muted warm tone for Ingredients */
}

.stat-card:nth-child(4) .stat-number {
  color: #8b9dc3 !important; /* Muted cool tone for High Confidence */
}

.stat-label {
  color: var(--text) !important;
  font-size: 0.85rem !important;
  font-weight: 500 !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
}

/* Force horizontal layout and prevent wrapping */
.review-stats > * {
  flex-shrink: 0 !important;
  margin: 0 !important;
}

/* Ensure stats are in a single row */
.review-stats {
  overflow-x: auto !important;
  white-space: nowrap !important;
  padding: 0.5rem 0 !important;
}

.batch-actions-section {
  margin-bottom: 2rem;
}

.batch-actions-section h4 {
  margin-bottom: 1rem;
  color: var(--text);
}

.batch-actions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1rem;
}

.batch-action-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 1rem;
}

.batch-action-card h5 {
  margin: 0 0 0.5rem 0;
  color: var(--text);
}

.batch-action-card p {
  margin: 0 0 1rem 0;
  color: var(--muted);
  font-size: 0.9rem;
}

.filter-section {
  margin-bottom: 2rem;
  padding: 1.5rem;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

.filter-controls {
  display: flex !important;
  gap: 1.5rem;
  align-items: center;
  flex-wrap: wrap;
  flex-direction: row !important;
  width: 100%;
}

.filter-group {
  display: flex !important;
  align-items: center;
  gap: 0.5rem;
  flex-shrink: 0;
}

.filter-label {
  font-weight: 500;
  color: var(--text);
  font-size: 0.9rem;
}

.search-input, .filter-select {
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--card-bg);
  color: var(--text);
  min-width: 150px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.search-input:focus, .filter-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.2);
  transform: translateY(-1px);
}

.btn-secondary {
  background: var(--card-bg);
  border: 1px solid var(--border);
  color: var(--text);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-secondary:hover {
  background: var(--hover);
  border-color: var(--primary);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
}

.item-info {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.confidence-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 500;
}

.confidence-high {
  background: rgba(76, 175, 80, 0.2);
  color: #4caf50;
}

.confidence-medium {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
}

.confidence-low {
  background: rgba(244, 67, 54, 0.2);
  color: #f44336;
}

.quick-actions {
  display: flex;
  gap: 0.5rem;
}

.btn-quick {
  padding: 0.25rem 0.5rem;
  border: 1px solid;
  border-radius: 4px;
  background: none;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.2s ease;
}

.btn-quick-new {
  border-color: var(--primary);
  color: var(--primary);
}

.btn-quick-new:hover {
  background: var(--primary);
  color: var(--bg);
}

.btn-quick-match {
  border-color: var(--accent);
  color: var(--accent);
}

.btn-quick-match:hover {
  background: var(--accent);
  color: var(--bg);
}

.item-context {
  background: rgba(212, 175, 55, 0.1);
  padding: 0.75rem;
  border-radius: 4px;
  margin-bottom: 1rem;
  border-left: 3px solid var(--primary);
}

.no-results {
  text-align: center;
  padding: 3rem;
  color: var(--muted);
  animation: fadeIn 0.4s ease-out;
}

.no-results h3 {
  margin: 1rem 0 0.5rem 0;
  color: var(--text);
}

.review-item.filtered-out {
  opacity: 0.3;
  transform: scale(0.98);
  transition: all 0.3s ease;
}

.filter-section {
  position: relative;
}

.filter-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  border-radius: 12px 12px 0 0;
}

/* Multi-selection styles */
.matches-section, .new-item-section {
  margin-top: 1rem;
}

.checkbox-list, .radio-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.match-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 4px;
  transition: background-color 0.2s ease;
}

.match-option:hover {
  background-color: rgba(139, 179, 57, 0.1);
}

.match-option input[type="checkbox"] {
  transform: scale(1.2);
  margin-right: 0.5rem;
  accent-color: var(--accent);
}

.match-option input[type="radio"] {
  transform: scale(1.2);
  margin-right: 0.5rem;
  accent-color: var(--primary);
}

/* Visual feedback for conflicting selections */
.matches-section.conflicting .match-option {
  opacity: 0.6;
  pointer-events: none;
}

.new-item-section.conflicting {
  opacity: 0.6;
  pointer-events: none;
}

/* Prevention indicator */
.conflict-prevented {
  animation: shake 0.5s ease-in-out;
  border: 2px solid #ff9800 !important;
  background-color: rgba(255, 152, 0, 0.1) !important;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* Highlight active section */
.matches-section.active {
  border-left: 3px solid var(--accent);
  padding-left: 0.5rem;
}

.new-item-section.active {
  border-left: 3px solid var(--primary);
  padding-left: 0.5rem;
}

/* Disabled input styles */
.match-option input[type="checkbox"]:disabled,
.match-option input[type="radio"]:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.match-option input[type="checkbox"]:disabled + *,
.match-option input[type="radio"]:disabled + * {
  opacity: 0.5;
  cursor: not-allowed;
}

.matches-section.disabled .match-option {
  opacity: 0.5;
  pointer-events: none;
}

.new-item-section.disabled {
  opacity: 0.5;
  pointer-events: none;
}

.form-validation {
  margin-top: 1rem;
  padding: 0.75rem;
  border-radius: 6px;
  background-color: rgba(232, 90, 90, 0.1);
  border: 1px solid rgba(232, 90, 90, 0.3);
  color: #e85a5a;
  font-size: 0.9rem;
  display: none;
  animation: fadeIn 0.3s ease;
}

.form-validation i {
  margin-right: 0.5rem;
}

.form-validation p {
  margin: 0;
  display: flex;
  align-items: center;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 768px) {
  .filter-controls {
    flex-direction: row;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .search-input, .filter-select {
    min-width: auto;
  }
  
  .review-header {
    flex-direction: column;
    gap: 1rem;
  }
  
  .quick-actions {
    align-self: stretch;
    justify-content: center;
  }
  
  /* Responsive stats layout */
  .review-stats {
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
  }
  
  .stat-card {
    min-width: auto;
    padding: 1rem;
  }
  
  .stat-number {
    font-size: 2rem;
  }
  
  /* Mobile toast adjustments */
  .toast-notification {
    left: 20px;
    right: 20px;
    bottom: 20px;
    top: auto;
    min-width: auto;
  }
}
</style>
