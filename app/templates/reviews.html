{% extends "base.html" %}

{% block content %}
  <div class="d-flex align-items-center mb-4">
    <h2><i class="mdi mdi-clipboard-list-outline"></i> Review Matches</h2>
    <form method="post" action="{{ url_for('main.cancel_review') }}" style="margin-left:auto;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn primary">
        <i class="mdi mdi-close-circle-outline"></i>
        Cancel &amp; Start Over
      </button>
    </form>
  </div>

  <div style="margin-bottom: 2rem;">
    <h2 style="margin-bottom: 1rem; color: var(--text);">
      <i class="mdi mdi-clipboard-check-outline"></i>
      Product & Ingredient Match Review
    </h2>

    <!-- Dgraph Information -->
    <div style="background: rgba(139, 179, 57, 0.1); padding: 1rem; border-radius: 4px; border: 1px solid var(--accent);">
      <h4 style="color: var(--accent); margin: 0 0 0.5rem 0; font-size: 1rem;">
        <i class="mdi mdi-information-outline"></i> Review Process
      </h4>
      <p style="margin: 0; color: var(--text); font-size: 0.9rem; line-height: 1.4;">
        <strong>What you're reviewing:</strong> Products and ingredients from your uploaded file that need to be matched to existing records or marked as new.
        <br><br>
        <strong>Businesses:</strong> Are automatically created during file processing and don't require review.
        <br><br>
        <strong>Your choices:</strong> For each product/ingredient, approve a match to link to existing data, or mark as "new" to create a new record. 
        After completing all reviews, you can push the approved decisions to your database.
      </p>
    </div>
  </div>

  <!-- Review Statistics -->
  <div class="review-stats">
    <div class="stat-card">
      <div class="stat-number">{{ pending_reviews|length }}</div>
      <div class="stat-label">Pending Reviews</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ pending_reviews|selectattr('new_item.type', 'equalto', 'product')|list|length }}</div>
      <div class="stat-label">Products</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ pending_reviews|selectattr('new_item.type', 'equalto', 'ingredient')|list|length }}</div>
      <div class="stat-label">Ingredients</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">{{ pending_reviews|selectattr('score', 'ge', 80)|list|length }}</div>
      <div class="stat-label">High Confidence</div>
    </div>
  </div>

  <!-- Enhanced Batch Actions -->
  <div class="batch-actions-section">
    <h4><i class="mdi mdi-lightning-bolt"></i> Quick Actions</h4>
    
    <div class="batch-actions-grid">
      <div class="batch-action-card">
        <h5>High Confidence Items</h5>
        <p>Auto-approve items with 90%+ match confidence</p>
        <form method="post" action="{{ url_for('main.batch_approve_high_confidence') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn accent">
            <i class="mdi mdi-auto-fix-high"></i>
            Auto-Approve High Confidence
          </button>
        </form>
      </div>
      
      <div class="batch-action-card">
        <h5>All Items as New</h5>
        <p>Approve all pending items as new products/ingredients</p>
        <form method="post" action="{{ url_for('main.batch_save_decisions') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn accent">
            <i class="mdi mdi-content-save-all"></i>
            Save All as New Items
          </button>
        </form>
      </div>
      
      <div class="batch-action-card">
        <h5>Ignore All</h5>
        <p>Skip all pending review items</p>
        <form method="post" action="{{ url_for('main.batch_ignore_all') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn" style="color:#e85a5a; border-color:#e85a5a;">
            <i class="mdi mdi-trash-can-outline"></i>
            Ignore All
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Smart Filtering -->
  <div class="filter-section">
    <div class="filter-controls" style="display: flex !important; flex-direction: row !important; gap: 1.5rem; align-items: center; flex-wrap: wrap; width: 100%;">
      <div class="filter-group" style="display: flex !important; align-items: center; gap: 0.5rem; flex-shrink: 0;">
        <i class="mdi mdi-magnify" style="color: var(--primary);"></i>
        <input type="text" id="search-input" placeholder="Search items..." class="search-input">
      </div>
      
      <div class="filter-group" style="display: flex !important; align-items: center; gap: 0.5rem; flex-shrink: 0;">
        <label for="type-filter" class="filter-label">Type:</label>
        <select id="type-filter" class="filter-select" title="Filter by item type">
          <option value="">All Types</option>
          <option value="product">Products Only</option>
          <option value="ingredient">Ingredients Only</option>
        </select>
      </div>
      
      <div class="filter-group" style="display: flex !important; align-items: center; gap: 0.5rem; flex-shrink: 0;">
        <label for="confidence-filter" class="filter-label">Confidence:</label>
        <select id="confidence-filter" class="filter-select" title="Filter by confidence level">
          <option value="">All Confidence Levels</option>
          <option value="high">High (80%+)</option>
          <option value="medium">Medium (60-79%)</option>
          <option value="low">Low (<60%)</option>
        </select>
      </div>
      
      <button onclick="clearFilters()" class="btn btn-secondary">
        <i class="mdi mdi-filter-remove"></i>
        Clear Filters
      </button>
    </div>
  </div>

  <!-- Review Items -->
  <div id="review-items-container">
    {% for review in pending_reviews %}
      <div class="card mb-4 review-item" 
           data-type="{{ review.new_item.type }}"
           data-confidence="{{ 'high' if review.score >= 80 else 'medium' if review.score >= 60 else 'low' }}"
           data-name="{{ review.new_item.name.lower() }}">
        <div class="review-header">
          <div class="item-info">
            <h3 class="card-title">
              "{{ review.new_item.name }}"
            </h3>
            <span class="type-label {{ review.new_item.type|lower }}">
              {{ review.new_item.type|capitalize }}
            </span>
            <span class="confidence-badge confidence-{{ 'high' if review.score >= 80 else 'medium' if review.score >= 60 else 'low' }}">
              {{ "%.1f"|format(review.score) if review.score else 'N/A' }}%
            </span>
          </div>
          
          <!-- Quick Actions -->
          <div class="quick-actions">
            <button onclick="quickApprove('{{ review.new_item_id }}', 'new')" class="btn-quick btn-quick-new" title="Mark as New">
              <i class="mdi mdi-plus-circle"></i> New
            </button>
            {% if review.suggested_ext_id %}
            <button onclick="quickApprove('{{ review.new_item_id }}', '{{ review.suggested_ext_id }}')" class="btn-quick btn-quick-match" title="Use Best Match">
              <i class="mdi mdi-check-circle"></i> Match
            </button>
            {% endif %}
          </div>
        </div>
        
        <!-- Item Context -->
        <div class="item-context">
          <p style="margin: 0; color: var(--text); font-size: 0.9rem;">
            <strong>Source:</strong> {{ review.new_item.submission.name if review.new_item.submission else 'Unknown' }} | 
            <strong>Type:</strong> {{ review.new_item.type|capitalize }} | 
            <strong>Confidence:</strong> {{ "%.1f"|format(review.score) if review.score else 'N/A' }}%
          </p>
        </div>

                 <p class="card-text">
           Select one or more matches from your canonical data, mark as new, or ignore this item:
         </p>
         
         <!-- Canonical matches form with Save Decision button -->
         <form action="{{ url_for('main.handle_review', item_id=review.new_item_id) }}"
               method="post" style="margin-bottom:.5rem;" id="review-form-{{ review.new_item_id }}">
           <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
           
           <!-- Canonical Matches Section -->
           <div class="matches-section">
             <h5 style="color: var(--text); margin-bottom: 0.5rem;">
               <i class="mdi mdi-link-variant"></i> Canonical Matches (Select one or more):
             </h5>
             <ul class="checkbox-list">
               <!-- Top suggestion -->
               {% if review.suggested_ext_id %}
               <li>
                 <label class="match-option">
                   <input type="checkbox"
                          name="canonical_choices"
                          value="{{ review.suggested_ext_id }}"
                          class="canonical-checkbox"
                          data-form-id="{{ review.new_item_id }}">
                   <strong>{{ review.suggested_name }}</strong>
                   <span class="muted">({{ "%.2f"|format(review.score) }}%)</span>
                   <span style="color: var(--accent); font-size: 0.8rem;">‚Üê Best Match</span>
                 </label>
               </li>
               {% endif %}
               
               <!-- Alternatives -->
               {% for alt in review.alternatives %}
               <li style="padding-left:1.5rem;">
                 <label class="match-option">
                   <input type="checkbox"
                          name="canonical_choices"
                          value="{{ alt.ext_id }}"
                          class="canonical-checkbox"
                          data-form-id="{{ review.new_item_id }}">
                   {{ alt.name }}
                   <span class="muted">({{ "%.2f"|format(alt.score) }}%)</span>
                 </label>
               </li>
               {% endfor %}
             </ul>
           </div>
           
           <div class="form-validation" style="margin-top: 1rem; padding: 0.5rem; border-radius: 4px; display: none;" id="validation-{{ review.new_item_id }}">
             <p style="margin: 0; color: #e85a5a; font-size: 0.9rem;">
               <i class="mdi mdi-alert-circle"></i> 
               <span id="validation-text-{{ review.new_item_id }}">Please select at least one canonical match before submitting, or use "Create New" button.</span>
             </p>
           </div>
           
           <button type="submit" class="btn accent" id="submit-btn-{{ review.new_item_id }}">
             <i class="mdi mdi-content-save"></i>
             Save Decision
           </button>
         </form>
         
         <!-- New Item Section -->
         <div class="new-item-section" style="margin-top: 1rem;">
           <h5 style="color: var(--text); margin-bottom: 0.5rem;">
             <i class="mdi mdi-plus-circle"></i> Or Create New:
           </h5>
           <p style="margin: 0; color: var(--muted); font-size: 0.9rem;">
             If no canonical matches are suitable, create a new {{ review.new_item.type }} in Dgraph:
           </p>
         </div>
         
         <!-- Separate form for creating new item -->
         <form action="{{ url_for('main.handle_review', item_id=review.new_item_id) }}"
               method="post" style="margin-bottom:.5rem;">
           <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
           <input type="hidden" name="choice" value="__new__">
           <button type="submit" class="btn primary" style="margin-top: 1rem; margin-bottom: 1.5rem;">
             <i class="mdi mdi-plus-circle"></i>
             Create New {{ review.new_item.type|capitalize }}
           </button>
         </form>
        
        <form action="{{ url_for('main.ignore_review_item', item_id=review.new_item_id) }}" method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn" style="color:#e85a5a; border-color:#e85a5a; background:none; margin-top:.3rem;">
            <i class="mdi mdi-trash-can-outline"></i> Ignore / Remove this item
          </button>
        </form>
      </div>
    {% endfor %}
  </div>

  <!-- No results message -->
  <div id="no-results" class="no-results" style="display: none;">
    <div class="text-center">
      <i class="mdi mdi-magnify" style="font-size: 3rem; color: var(--muted);"></i>
      <h3>No items match your filters</h3>
      <p>Try adjusting your search criteria or clearing the filters.</p>
    </div>
  </div>
{% endblock %}

<script>
// Event listeners are now set up in the base template
console.log('Reviews page loaded - filters should be working!');

// Simple form validation for canonical choices
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DOMContentLoaded] Setting up form validation...');
    
    // Handle canonical checkbox changes for validation
    document.querySelectorAll('.canonical-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function(e) {
            const formId = this.getAttribute('data-form-id');
            console.log(`[Event] Canonical checkbox changed for form ${formId}: ${this.value}, checked: ${this.checked}`);
            validateForm(formId);
        });
    });

    // Handle form submissions for canonical choices
    document.querySelectorAll('form[id^="review-form-"]').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            const formId = this.id.replace('review-form-', '');
            const canonicalChoices = this.querySelectorAll('input[name="canonical_choices"]:checked');
            
            console.log(`[Submit] Form ${formId} - Canonical choices: ${canonicalChoices.length}`);
            
            // Simple validation - must have at least one canonical choice selected
            if (canonicalChoices.length === 0) {
                e.preventDefault();
                console.log(`[Submit] No canonical choices selected - preventing submission for form ${formId}`);
                alert('Please select at least one canonical match before submitting.');
                return false;
            }
        });
        
        // Initialize validation for each form
        const formId = form.id.replace('review-form-', '');
        validateForm(formId);
    });
});

function validateForm(formId) {
    const canonicalChoices = document.querySelectorAll(`#review-form-${formId} input[name="canonical_choices"]:checked`);
    const validationDiv = document.getElementById(`validation-${formId}`);
    const submitBtn = document.getElementById(`submit-btn-${formId}`);
    const validationText = document.getElementById(`validation-text-${formId}`);
    
    // Simple validation - must have at least one canonical choice selected
    const isValid = canonicalChoices.length > 0;
    
    if (!isValid) {
        validationDiv.style.display = 'block';
        validationText.textContent = 'Please select at least one canonical match before submitting, or use "Create New" button.';
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
    } else {
        validationDiv.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
    }
    
    return isValid;
}

// Quick approve functions (existing)
function quickApprove(itemId, choice) {
    const form = document.getElementById(`review-form-${itemId}`);
    if (!form) return;
    
    if (choice === 'new') {
        // Create a new form for the "Create New" action
        const newForm = document.createElement('form');
        newForm.method = 'POST';
        newForm.action = form.action;
        
        // Add CSRF token
        const csrfToken = form.querySelector('input[name="csrf_token"]');
        if (csrfToken) {
            const newCsrfInput = document.createElement('input');
            newCsrfInput.type = 'hidden';
            newCsrfInput.name = 'csrf_token';
            newCsrfInput.value = csrfToken.value;
            newForm.appendChild(newCsrfInput);
        }
        
        // Add choice parameter
        const choiceInput = document.createElement('input');
        choiceInput.type = 'hidden';
        choiceInput.name = 'choice';
        choiceInput.value = '__new__';
        newForm.appendChild(choiceInput);
        
        // Submit the form
        document.body.appendChild(newForm);
        newForm.submit();
    } else {
        // Clear all selections first
        form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        
        // Select the specific canonical match
        const checkbox = form.querySelector(`input[value="${choice}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
        
        // Validate and submit
        if (validateForm(itemId)) {
            form.submit();
        }
    }
}
</script>

<style>
.review-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 1rem;
  text-align: center;
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 0.5rem;
}

.stat-label {
  color: var(--muted);
  font-size: 0.9rem;
}

.batch-actions-section {
  margin-bottom: 2rem;
}

.batch-actions-section h4 {
  margin-bottom: 1rem;
  color: var(--text);
}

.batch-actions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1rem;
}

.batch-action-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 1rem;
}

.batch-action-card h5 {
  margin: 0 0 0.5rem 0;
  color: var(--text);
}

.batch-action-card p {
  margin: 0 0 1rem 0;
  color: var(--muted);
  font-size: 0.9rem;
}

.filter-section {
  margin-bottom: 2rem;
  padding: 1.5rem;
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

.filter-controls {
  display: flex !important;
  gap: 1.5rem;
  align-items: center;
  flex-wrap: wrap;
  flex-direction: row !important;
  width: 100%;
}

.filter-group {
  display: flex !important;
  align-items: center;
  gap: 0.5rem;
  flex-shrink: 0;
}

.filter-label {
  font-weight: 500;
  color: var(--text);
  font-size: 0.9rem;
}

.search-input, .filter-select {
  padding: 0.75rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--card-bg);
  color: var(--text);
  min-width: 150px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.search-input:focus, .filter-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.2);
  transform: translateY(-1px);
}

.btn-secondary {
  background: var(--card-bg);
  border: 1px solid var(--border);
  color: var(--text);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-secondary:hover {
  background: var(--hover);
  border-color: var(--primary);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
}

.item-info {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.confidence-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 500;
}

.confidence-high {
  background: rgba(76, 175, 80, 0.2);
  color: #4caf50;
}

.confidence-medium {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
}

.confidence-low {
  background: rgba(244, 67, 54, 0.2);
  color: #f44336;
}

.quick-actions {
  display: flex;
  gap: 0.5rem;
}

.btn-quick {
  padding: 0.25rem 0.5rem;
  border: 1px solid;
  border-radius: 4px;
  background: none;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.2s ease;
}

.btn-quick-new {
  border-color: var(--primary);
  color: var(--primary);
}

.btn-quick-new:hover {
  background: var(--primary);
  color: var(--bg);
}

.btn-quick-match {
  border-color: var(--accent);
  color: var(--accent);
}

.btn-quick-match:hover {
  background: var(--accent);
  color: var(--bg);
}

.item-context {
  background: rgba(212, 175, 55, 0.1);
  padding: 0.75rem;
  border-radius: 4px;
  margin-bottom: 1rem;
  border-left: 3px solid var(--primary);
}

.no-results {
  text-align: center;
  padding: 3rem;
  color: var(--muted);
  animation: fadeIn 0.4s ease-out;
}

.no-results h3 {
  margin: 1rem 0 0.5rem 0;
  color: var(--text);
}

.review-item.filtered-out {
  opacity: 0.3;
  transform: scale(0.98);
  transition: all 0.3s ease;
}

.filter-section {
  position: relative;
}

.filter-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  border-radius: 12px 12px 0 0;
}

/* Multi-selection styles */
.matches-section, .new-item-section {
  margin-top: 1rem;
}

.checkbox-list, .radio-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.match-option {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 4px;
  transition: background-color 0.2s ease;
}

.match-option:hover {
  background-color: rgba(139, 179, 57, 0.1);
}

.match-option input[type="checkbox"] {
  transform: scale(1.2);
  margin-right: 0.5rem;
  accent-color: var(--accent);
}

.match-option input[type="radio"] {
  transform: scale(1.2);
  margin-right: 0.5rem;
  accent-color: var(--primary);
}

/* Visual feedback for conflicting selections */
.matches-section.conflicting .match-option {
  opacity: 0.6;
  pointer-events: none;
}

.new-item-section.conflicting {
  opacity: 0.6;
  pointer-events: none;
}

/* Prevention indicator */
.conflict-prevented {
  animation: shake 0.5s ease-in-out;
  border: 2px solid #ff9800 !important;
  background-color: rgba(255, 152, 0, 0.1) !important;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* Highlight active section */
.matches-section.active {
  border-left: 3px solid var(--accent);
  padding-left: 0.5rem;
}

.new-item-section.active {
  border-left: 3px solid var(--primary);
  padding-left: 0.5rem;
}

/* Disabled input styles */
.match-option input[type="checkbox"]:disabled,
.match-option input[type="radio"]:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.match-option input[type="checkbox"]:disabled + *,
.match-option input[type="radio"]:disabled + * {
  opacity: 0.5;
  cursor: not-allowed;
}

.matches-section.disabled .match-option {
  opacity: 0.5;
  pointer-events: none;
}

.new-item-section.disabled {
  opacity: 0.5;
  pointer-events: none;
}

.form-validation {
  margin-top: 1rem;
  padding: 0.75rem;
  border-radius: 6px;
  background-color: rgba(232, 90, 90, 0.1);
  border: 1px solid rgba(232, 90, 90, 0.3);
  color: #e85a5a;
  font-size: 0.9rem;
  display: none;
  animation: fadeIn 0.3s ease;
}

.form-validation i {
  margin-right: 0.5rem;
}

.form-validation p {
  margin: 0;
  display: flex;
  align-items: center;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 768px) {
  .filter-controls {
    flex-direction: row;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .search-input, .filter-select {
    min-width: auto;
  }
  
  .review-header {
    flex-direction: column;
    gap: 1rem;
  }
  
  .quick-actions {
    align-self: stretch;
    justify-content: center;
  }
}


</style>
